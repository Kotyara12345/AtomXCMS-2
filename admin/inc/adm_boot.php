<?php
/**
 * ============================================================
 *  adm_boot.php
 * ============================================================
 *  Bootstrap-файл административного модуля CMS AtomX
 *
 *  Автор: Andrey Brykin (Drunya)
 *  Версия: 1.3
 *  Последняя модификация: 2014-01-10
 *
 *  Адаптация:
 *   - Совместимость с PHP 8.1+
 *   - Аккуратная структура
 *   - Комментарии к логике
 * ============================================================
 */

declare(strict_types=1);

/* ============================================================
 *  Служебные комментарии исходного файла
 * ============================================================ */

##################################################
##                                              ##
## @Author:       Andrey Brykin (Drunya)        ##
## @Version:      1.3                           ##
## @Project:      CMS                           ##
## @package       CMS AtomX                     ##
## @subpackege    Admin module                  ##
## @copyright     ©Andrey Brykin 2010-2014      ##
## @Last mod.     2014/01/10                    ##
##################################################

##################################################
##                                              ##
...

/* ============================================================
 *  Проверка на прямой доступ к файлу
 * ============================================================ */

if (!defined('ADMIN')) {
    exit('Access denied');
}

/* ============================================================
 *  Инициализация основных путей
 * ============================================================ */

if (!defined('ROOT')) {
    define('ROOT', dirname(__DIR__));
}

if (!defined('DS')) {
    define('DS', DIRECTORY_SEPARATOR);
}

/* ============================================================
 *  Подключение функций и конфигураций
 * ============================================================ */

$functionsFile = ROOT . DS . 'sys' . DS . 'functions.php';
if (file_exists($functionsFile)) {
    require_once $functionsFile;
}

/* ============================================================
 *  Функция получения списка модулей
 * ============================================================ */

/**
 * Получает список административных модулей
 *
 * @param string $path Путь к директории модулей
 * @return array
 */
function getAdminModules(string $path): array
{
    $out = [];

    // Проверка существования директории
    if (!is_dir($path)) {
        return $out;
    }

    // Получаем список файлов и папок
    $modules = scandir($path);
    if ($modules === false) {
        return $out;
    }

    // Удаляем служебные элементы
    $modules = array_diff($modules, ['.', '..']);

    if (count($modules)) {
        foreach ($modules as $key => $modPath) {

            $fullPath = $path . DS . $modPath;

            // Работаем только с директориями
            if (!is_dir($fullPath)) {
                continue;
            }

            // Файл описания модуля
            $infoFile = $fullPath . DS . 'info.php';

            if (file_exists($infoFile)) {

                /**
                 * info.php должен объявлять переменную $menuInfo
                 * Используется include, так как это часть логики CMS
                 */
                $menuInfo = null;
                include $infoFile;

                if (isset($menuInfo)) {
                    $out[$modPath] = $menuInfo;
                }
            }
        }
    }

    return $out;
}

/* ============================================================
 *  Конец файла
 * ============================================================ */

?>
